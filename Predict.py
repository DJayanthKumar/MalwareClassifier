#importing libraries
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.linear_model import LogisticRegression
from mlxtend.classifier import StackingClassifier

#Reading Dataset
dataset = pd.read_excel('Anomalies.xls')
X = dataset.iloc[:,:-1].values
Y = dataset.iloc[:,7:8].values

#Categorical values
from sklearn.preprocessing import LabelEncoder,OneHotEncoder
enc = LabelEncoder()
Y = enc.fit_transform(Y)

#Splitting Train and Test Data
from sklearn.cross_validation import train_test_split
X_train,X_test,Y_train,Y_test = train_test_split(X,Y,test_size=0.2)

'''#Feature Standardisation
from sklearn.preprocessing import StandardScaler
sc = StandardScaler()
X_train = sc.fit_transform(X_train)
X_test = sc.transform(X_test)'''

from imblearn.over_sampling import SMOTE
sm = SMOTE(random_state=12, ratio = 1.0)
X_train, Y_train = sm.fit_sample(X_train, Y_train)

# Fitting Random Forest Classification to the Training set
from sklearn.ensemble import RandomForestClassifier
KNN_classifier = RandomForestClassifier()

from sklearn.neighbors import KNeighborsClassifier
forest_classifier = KNeighborsClassifier()

'''from sklearn.svm import SVC
clf = SVC()
clf.fit(X_train, Y_train)'''

lr = LogisticRegression()
sclf = StackingClassifier(classifiers=[KNN_classifier,forest_classifier],
                          meta_classifier=lr)

sclf.fit(X_train, Y_train)

Y_pred = sclf.predict(X_test)

from sklearn.metrics import confusion_matrix
cm = confusion_matrix(Y_test, Y_pred)

from sklearn.metrics import accuracy_score
accuracy_score(Y_test, Y_pred)
#accuracy_score(Y_train, Y_pred_train)

from sklearn.externals import joblib
joblib.dump(sclf, 'malware_classifier.pkl')
joblib.dump(enc, 'label_encoder.pkl')